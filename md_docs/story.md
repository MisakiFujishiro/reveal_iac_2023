# Introduction
----
## 参加の理由
- 案件でIaCを利用
- 導入する中で、どうすれば運用が改善されるかを試行錯誤した
- 正しく運用をするための知見を整理し、体系化することを目指したい
----

## テーマと目標設定
計画シート参照

---




# DevOpsとIaC
----

## DevOpsの価値
<div style="font-size: 0.8em;">
    <p>
        プロダクトの提供価値を高めるために、プロダクトに求められるリリースの速度や回数の要求は増大している。<br>
        この課題に対して求められるチームの文化がDevOpsである<br>
        DevOpsとは、DevとOpsが協力してツールや働き方によって、リスクを低減する文化
    </p>
</div>

----

## DevOpsに必要なもの
<div style="font-size: 0.8em;">
    <p>
        ソフト面(文化)とハード面(ツール)両方での取り組みが必要
    </p>
</div>

- ソフト面（今回はスキップ
    - 目的意識
    - 文化への理解
    - チームビルディング
- ハード面（今回のメインテーマ
    - 可視化
    - 専門性の排除
    - コミュニケーション

----

## IaCの価値
<div style="font-size: 0.8em;">
    <p>
        IaCとは、インフラの設定などをソースコードにより記述し、構築する技術<br>
        IaCを利用することで、可視化や専門性の排除に寄与することができる。
    </p>
</div>

- 可視化
    - バージョン管理の導入
    - チケット管理の導入
- 専門性排除
    - 手順書の簡略化
    - ビルドやテストの自動化

---






# IaCの運用
----
## アンチパターン・課題
<div style="font-size: 0.8em;">
    <p>
        案件でもIaCを導入していたが導入時点でも運用時点でも課題があった。<br>
        塾の中でIaCについて詳しいメンバーを交えてアンチパターンや課題のブレストを実施
    </p>
</div>

MindMapの画像イメージ

----
## アンチパターンのカテゴライズとテーマ選定
<div style="font-size: 0.8em;">
    <p>
        アンチパターンについてカテゴライズし、課題の中で効果が大きく、改善できるテーマをピックアップ<br>
    </p>
</div>


<div style="font-size: 0.8em;">
    <p>
    多段の表形式で、以下を整理してテーマを色付け<br>
        - どこから導入していけば良いかわからない<br>
        - どのように運用すればいいかわからない<br>
        - どのツールを利用すれば良いかわからない<br>
        - コード自体の管理が大変になる<br>
        - 正しく運用されない<br>
        - 手動運用が始まり、IaCが利用できなくなる<br>
        - どのように始めればいいかわからない（ソフト面）<br>
    </p>
</div>


---


# 始め方
----
## IaCのCICDとGitOpsの価値
<div style="font-size: 0.8em;">
    <p>
        IaC単独：リソースを可視化できるが、環境への反映状況などが不明瞭で管理が手間<br>
        CICD/GitOps導入：環境反映の可視化やバージョン管理が簡易になる
    </p>
</div>

2枚スライドを利用して、課題と改善点が明確になるようにする

----
## GitOpsスターターセット
<div style="font-size: 0.8em;">
    <p>
        使い慣れたgitとAWSのCodeCommitを連携させ、ソースコードからAWSのIaCのサービスであるCloudFormationの実行までを一気通貫にする。<br>
        基本知識として、Pipelineのステージ間のファイルやりとりはArtifactとしてS3を経由する。
    </p>
</div>

作成されるイメージを作成（Roleも含める）

----
## ソースステージ
<div style="font-size: 0.8em;">
    <p>
        gitとcodecommitの連携にはcodecommitへのアクセス権限を持ったUserの作成と
        git側からUserへの認証設定がポイント
    </p>
</div>

gitlabを利用する場合はミラーリング機能、それ以外の場合はSSHによる認証機能を利用


----
## ビルドステージ
<div style="font-size: 0.8em;">
    <p>
        CodeBuildではBuild PJを作成しておいて、対象PJをPipelineで実行する。<br>
        BuildPJでは、実行環境などを準備するだけで、実際にBuildで実行する内容はソースコード側でbuildspe.yamlとして指定する。<br>
        今回は、ArtifactとしてテンプレートファイルをDeployステージにわたす処理を書いておく<br>
        なので、Roleには、S3へのアクセス権限とログ用のCloudWatchを付与
    </p>
</div>

左側に実行イメージ、右側にIAMの設定

----
## デプロイステージ
<div style="font-size: 0.8em;">
    <p>
        デプロイステージとしてはCloudFormationの実行を行う。<br>
        CFNにはRoleを付与するが、このRoleは実際にリソースを作成・削除するので権限が強くなる点に注意
    </p>
</div>

左側に実行イメージ、右側にIAMの設定

----
## Codepipelineについて
<div style="font-size: 0.8em;">
    <p>
        上記のソースステージ・ビルドステージ・デプロイステージを一気に実行する<br>
        ソースステージにアクセスしたり、CFNを実行するために権限が必要。またcfnにRoleを渡すのでPassRoleも必要<br>
        CodeCommitの変化をきっかけにPipelineをキックする必要があるのでそのためのEventも作成しておく
    </p>
</div>

左側に実行イメージ、右側にIAMの設定

---



# 運用のTips
----
## 運用のための対策
<div style="font-size: 0.8em;">
    <p>
        正しく運用されるために解決するための課題をリストアップ
    </p>
</div>

整理したアンチパターンの粒度に合わせて、以下扱うテーマを一覧化

----
## 開発ツールとセキュリティ担保（テスト）
<div style="font-size: 0.8em;">
    <p>
        IaCを開発するための基本的なツールセットやテストの環境準備がないと、品質が担保されない<br>
        おすすめの開発ツールを紹介
    </p>
</div>

- VSCodeとプラグイン
    - linter
    - セキュリティ

----
## 品質担保のルール
<div style="font-size: 0.8em;">
    <p>
        IaCのコード品質のガイドラインを作成しないと、特定メンバーのみが触れることになる。<br>
        ガイドラインとして整理すべきものとガイドライン案を整理
    </p>
</div>

- 命名規則
- テンプレートの作成   
    - 記述単位の整理
    - 利用するCFNの文法
- ReadMe
- RV体制



----
## 開発フロー案
<div style="font-size: 0.8em;">
    <p>
        課題は、IaCの修正が業務的な変更との関連が不明瞭であること。<br>
        Devまではチケット管理ができている場合が多いが、Ops系のIaCまでチケット管理できていない<br>
        gitlabやjiraとの連携を利用した業務フロー案をリストアップ
    </p>
</div>

- gitlabオンリー
- jiraとgitlabの組み合わせ

----
## gitlabのよる開発フロー
<div style="font-size: 0.8em;">
    <p>
        Epic・Issue・マイルストーン・branch管理<br>
        できること・できないこと、メリットデメリット
    </p>
</div>


----
## gitlabとjiraによる開発フロー
<div style="font-size: 0.8em;">
    <p>
        連携方法・Epic・Issue・タイムライン・branch管理<br>
        できること・できないこと、メリットデメリット
    </p>
</div>

---




# デモ
----
## ストーリー
<div style="font-size: 0.8em;">
    <p>
        IaCを利用して、dev/prdの2環境にリリースしたい<br>
        JIRAでチケット管理・gitlabでソースコード管理をしている<br>
        リリースしたいのはLambdaとEvent Bridge
    </p>
</div>

----
## 課題
<div style="font-size: 0.8em;">
    <p>
        IaCと各環境へのリリース状況がわからない<br>
        IaCのソースコード管理が増加する<br>
        業務的背景が不明なので、IaCの管理単位が不明
    </p>
</div>

----
## TOBE像
<div style="font-size: 0.8em;">
    <p>
        gitopsを導入することで、バージョン管理とリリース状況下一目瞭然<br>
        branchをjiraから作成することで作業と業務背景の確認が容易
    </p>
</div>

---



# まとめ
----
## 目標達成状況