# Introduction
----
## 参加の理由
<div style="font-size: 0.6em;">
    <p>
        担当案件でIaCの導入に挑戦し、数多くの課題に見舞われ、塾参加時点では、チームでのIaC運用が大きな課題だった。<br>
        この課題に対する解決策を模索するとともに、これまで取り組んだ課題と解決策を体系化し、同じようなPJ助けになるようなドキュメントを整理したかった。
    </p>
</div>

************

<div style="font-size: 0.6em;">
    <p>
    フローの図で「導入前→導入時→運用時」でそれぞれでざっくりした課題を書く<br>
    導入前：IaCの価値がわからない/どこから始めるべきか/どのようなツールを導入するべきか/<br>
    導入時：コードの管理単位がわからない/すでに手動作成リソースがある<br>
    導入後：環境ごとのリリース状況が分からなくなる/チーム全体でIaCをどう運用するべきか決まらない/開発フローが定まらない
    </p>
</div>


----

## テーマと目標設定
計画シート参照

---




# IaCの価値とPJ適用時の課題
----
## DevOpsとIaC
<div style="font-size: 0.8em;">
    <p>
        Productに求められる価値の変化が素早く変化していくことで、プロダクトに求められるリリースの速度や回数の要求は増大している。<br>
        この課題に対して、DevとOpsが協力してツールや働き方によって、リスクを低減する文化がDevOpsである<br>
        DevOpsを実現するための一つのツールがインフラの設定などをソースコードにより記述し、構築する技術IaCである
    </p>
</div>

************
<div style="font-size: 0.8em;">
    <p>
        左から、Society・DevOps・IaCをブロックで書いておく
    </p>
</div>

----

## IaCのメリット
<div style="font-size: 0.8em;">
    <p>
        IaCを導入することにより、品質担保・ポータビリティ、インフラの可視化、自動化・専門性の低減などのメリットを享受。
    </p>
</div>

************

<div style="font-size: 0.6em;">
    <p>
    左からポータビリティ、可視化・専門性排除・自動化のブロックを作成<br>
    品質担保・ポータビリティ：複数の環境に同一品質のリソースを素早く展開することができる。<br>
    可視化：インフラ状態を表す鏡になる。バージョン管理が可能となり、Devチームでも扱いやすくなる。チーム間の隔たりを減らす<br>
    専門性の排除・自動化：宣言的な文法なので習得のハードルが低い。コードに対してテストやCICD Pipelineによるデプロイが行えるためインフラ構築やテストなど専門性が必要な作業を自動化可能<br>
    </p>
</div>

----

## IaCを適用する際の課題
<div style="font-size: 0.8em;">
    <p>
        担当PJにおいても様々な課題に見舞われた。<br>
        塾の中でIaCについて詳しいメンバーを交えてアンチパターンや課題のブレストを実施し整理
    </p>
</div>

************

<div style="font-size: 0.6em;">
    <p>
    ソフトハード・導入前中後の観点などを多段の表形式で、流れになるように以下を整理してテーマを色付け<br>
        - 以下の具体例とかも加筆<br>
        - 導入させてもらえない<br>
        - 最初から100点を求められる<br>
        - どこから導入していけば良いかわからない<br>
        - どのツールを利用すれば良いかわからない<br>
        - どのように始めればいいかわからない<br>
        - 環境ごとにどのIaCが適用されているかが不明になる<br>
        - どのように運用すればいいかわからない<br>
        - 手動運用が始まり、IaCが利用できなくなる<br>
        - Devチームへのスキルトランスファーができない<br>
        - DevチームでもIaCを触ってもらうために何を準備すれば良いか分からない
        - コード自体の管理が大変になる<br>
    </p>
</div>



----
## 取り扱うテーマ
<div style="font-size: 0.8em;">
    <p>
    今回の塾活動で取り扱う課題は以下<br>
    どのように始めるか（ハード面）<br>
    導入後どのように運用するか
    </p>
</div>

************

<div style="font-size: 0.6em;">
    <p>
    左から導入と運用のブロックを作成<br>
    始め方：gitopsを用いたIaCの開発スターターセットのイメージ<br>
    運用：開発のフロー。個人の設定〜チームとしてのgitopsの管理のイメージ
    </p>
</div>


---







# IaCのスターターセット
----
## IaCにおけるCICDとGitOps

<div style="font-size: 0.8em;">
    <p>
        IaCのメリットである、ポータビリティや可視化のメリットを十分に享受するためには、IaCを導入する際にGitOpsと合わせて導入することが望ましい。
    </p>
</div>

*********

<div style="font-size: 0.8em;">
    <p>
        2枚スライドを利用して、課題と改善点が明確になるようにする。（環境の設定なども絵でわかるように）<br>
        IaC単独：リソースを可視化できるが、環境への反映状況などが不明瞭で管理が手間<br>
        CICD/GitOps導入：環境反映の可視化やバージョン管理が簡易になる
    </p>
</div>


----
## GitOpsスターターセット
<div style="font-size: 0.8em;">
    <p>
        使い慣れたgitとAWSのを連携させ、ソースコードからAWSのIaCのサービスであるCloudFormationの実行までを連携させることが望ましい。<br>
        実行の方法は案件によって望ましい形があるが、今回はシンプルなCICD Pipelineを利用したスタータセットとする。
    </p>
</div>

*********

<div style="font-size: 0.8em;">
    <p>
        Roleを含めない、一連のPipelineの図を用意
    </p>
</div>

----
## GitOpsのスターターセット注意点
<div style="font-size: 0.8em;">
    <p>
        課題でもあったが、導入時はステークホルダーに対して心理的障壁を下げることが望ましい。<br>
        特に認可周りなどを整理して合意しないと導入を遠ざけることになるので、Roleの役割などを整理しておく必要がある。
    </p>
</div>

*********

<div style="font-size: 0.8em;">
    <p>
        Roleまで含めた一連のPipelineの図を用意
    </p>
</div>


----
## ソースステージ
<div style="font-size: 0.8em;">
    <p>
        AWSにはCodeCommitというgit機能を提供するサービスがあるが、機能的にはgitlabやgithubの方が優れている<br>
        gitlabやgithubで開発を行い、codecommitへミラーリングすることでAWS側にコードを反映させるフローが推奨<br>
        ポイントは、gitlab/hub側がAWSのCodeCommitへアクセスするための認証認可のフロー
    </p>
</div>

*********

左：codecommitへのアクセス権限だけを持ったUser

右：gitlab/hubからこのユーザーを利用したい。2つの方法があり、gitlabを利用する場合はミラーリング機能、それ以外の場合はSSHによる認証機能を利用


----
## ビルドステージ
<div style="font-size: 0.8em;">
    <p>
        CodeBuildを利用し、デプロイステージで利用するために、ソースステージで取得したコードをS3にPutする。
        ソースコードに対して、環境ごとのパラメータを渡すような設定をする場合はbuildspec.yamlやCodebuildの環境変数を利用。
        また、ビルドのログを残すためにCloudWatchへの認可も設定しておく
    </p>
</div>

*********

左：IAM Roleの概説

右：CodeBuildの役割や環境変数のイメージ

----
## デプロイステージ
<div style="font-size: 0.8em;">
    <p>
        デプロイステージとしてはCloudFormationの実行を行う。<br>
        CFNにはRoleを付与するが、このRoleは実際にリソースを作成・削除するので権限が強くなる点に注意
    </p>
</div>

*********

実際に作成したいリソースに対する権限を持っていなくてはいけないことに注意。
そして、ロールバックに備えて削除権限なども必要になってくる。こちらの運用に対しては後述

----
## CodeDeployが持つ権限に対する対策
- gitのマージで止める
- pipelineの承認プロセスで止める


----
## Codepipelineについて
<div style="font-size: 0.8em;">
    <p>
        上記のソースステージ・ビルドステージ・デプロイステージを一気に実行する<br>
        CodePipelineはソースステージにアクセス、CFNを実行する。
        必要な認可としては、CodeCommitに対する権限とCDNを実行するための権限が必要。<br>
        併せて、CodeCommitの変化をきっかけにPipelineをキックする必要があるのでそのためのEventも作成する
    </p>
</div>

*******

左：IAM Roleの概説

右：CodeBuildの役割や環境変数のイメージ



---












# IaCの運用TIPS
----
## IaCの開発フロー
<div style="font-size: 0.8em;">
    <p>
        IaCを運用する際に、どのような開発フローをすることで開発がしやすくなるか
        また、DevチームにもIaCを修正することができる環境を準備することでDevOpsに近づけることができるが、何を準備するべきか。
    </p>
</div>

運用の開発フローを絵で描いてみる
業務的な背景→インフラリソースの開発依頼→個人での開発→RV→デプロイ


----
## 開発ツールとセキュリティ担保（テスト）
<div style="font-size: 0.8em;">
    <p>
        IaCを開発するための基本的なツールセットやテストの環境準備がないと、品質が担保されない<br>
        おすすめの開発ツールを紹介
    </p>
</div>

- VSCodeとプラグイン
    - linter
    - セキュリティ




----
## 品質担保のルール
<div style="font-size: 0.8em;">
    <p>
        IaCのコード品質のガイドラインを作成しないと、特定メンバーのみが触ることになる。<br>
        ガイドラインとして整理すべきものとガイドライン案を整理
    </p>
</div>

- 命名規則
- テンプレートの作成   
    - 記述単位の整理
    - 利用するCFNの文法
- ReadMe
- RV体制



----
## 開発フロー案
<div style="font-size: 0.8em;">
    <p>
        開発フローの中で業務的な背景との関連付けがないと、IaCの管理単位などの軸が決めれなくなり、後々の修正が必要になる。<br>
        Devまではチケット管理ができている場合が多いが、Ops系のIaCまでチケット管理できていない<br>
        gitlab単独での管理、jiraとgitlabの組み合わせなど様々なパターンがあるが、今回は一例として、チケット管理をjira、開発をgitlabで実施していた場合を想定して、開発フローの一案を紹介
    </p>
</div>

- どうやって連携するか
- 連携することでできること
- 具体的なメリット




# デモ
----
## ストーリー
<div style="font-size: 0.8em;">
    <p>
        IaCを利用して、dev/prdの2環境にリリースしたい<br>
        JIRAでチケット管理・gitlabでソースコード管理をしている<br>
        リリースしたいのはLambdaとEvent Bridge
    </p>
</div>

----
## 課題
<div style="font-size: 0.8em;">
    <p>
        IaCと各環境へのリリース状況がわからない<br>
        IaCのソースコード管理が増加する<br>
        業務的背景が不明なので、IaCの管理単位が不明
    </p>
</div>

----
## TOBE像
<div style="font-size: 0.8em;">
    <p>
        gitopsを導入することで、バージョン管理とリリース状況下一目瞭然<br>
        branchをjiraから作成することで作業と業務背景の確認が容易
    </p>
</div>

---



# まとめ
----
## 目標達成状況